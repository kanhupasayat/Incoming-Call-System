<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incoming Calls Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            color: #333;
            font-size: 32px;
            font-weight: bold;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .filters input, .filters select, .filters button {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .filters button {
            background: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }

        .filters button:hover {
            background: #0056b3;
        }

        .calls-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
        }

        td {
            padding: 15px;
            border-top: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .lead-hot {
            background: #ff6b6b;
            color: white;
        }

        .lead-warm {
            background: #ffd93d;
            color: #333;
        }

        .lead-cold {
            background: #95e1d3;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìû Incoming Calls Dashboard</h1>

        <div class="stats-grid" id="statsGrid">
            <div class="loading">Loading statistics...</div>
        </div>

        <div class="filters">
            <input type="search" id="searchInput" placeholder="Search caller number, name...">
            <select id="statusFilter">
                <option value="">All Status</option>
                <option value="completed">Completed</option>
                <option value="answered">Answered</option>
                <option value="no-answer">No Answer</option>
                <option value="busy">Busy</option>
            </select>
            <select id="leadFilter">
                <option value="">All Calls</option>
                <option value="true">Leads Only</option>
                <option value="false">Non-Leads</option>
            </select>
            <select id="leadQualityFilter">
                <option value="">All Lead Quality</option>
                <option value="hot">Hot Leads</option>
                <option value="warm">Warm Leads</option>
                <option value="cold">Cold Leads</option>
            </select>
            <button onclick="loadCalls()">üîç Search</button>
            <button onclick="resetFilters()">üîÑ Reset</button>
        </div>

        <div class="calls-table">
            <table>
                <thead>
                    <tr>
                        <th>Call ID</th>
                        <th>Caller</th>
                        <th>Time</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Staff</th>
                        <th>Disposition</th>
                        <th>Vehicle</th>
                        <th>Lead</th>
                    </tr>
                </thead>
                <tbody id="callsTableBody">
                    <tr>
                        <td colspan="9" class="loading">Loading calls...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000/api';

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/calls/stats/`);
                const data = await response.json();

                const statsHtml = `
                    <div class="stat-card">
                        <h3>Total Calls</h3>
                        <div class="value">${data.total_calls}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Answered</h3>
                        <div class="value">${data.answered_calls}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Missed</h3>
                        <div class="value">${data.missed_calls}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Leads</h3>
                        <div class="value">${data.total_leads}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Hot Leads</h3>
                        <div class="value">${data.hot_leads}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg Duration</h3>
                        <div class="value">${Math.round(data.average_duration)}s</div>
                    </div>
                `;

                document.getElementById('statsGrid').innerHTML = statsHtml;
            } catch (error) {
                document.getElementById('statsGrid').innerHTML =
                    '<div class="error">Error loading statistics</div>';
            }
        }

        async function loadCalls() {
            const search = document.getElementById('searchInput').value;
            const status = document.getElementById('statusFilter').value;
            const isLead = document.getElementById('leadFilter').value;
            const leadQuality = document.getElementById('leadQualityFilter').value;

            let url = `${API_BASE}/calls/?`;
            if (search) url += `search=${search}&`;
            if (status) url += `status=${status}&`;
            if (isLead) url += `is_lead=${isLead}&`;
            if (leadQuality) url += `lead_quality=${leadQuality}&`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    const callsHtml = data.results.map(call => `
                        <tr>
                            <td>${call.call_id}</td>
                            <td>
                                <strong>${call.caller_name || 'Unknown'}</strong><br>
                                <small>${call.caller_number}</small>
                            </td>
                            <td>${new Date(call.call_start_time).toLocaleString('hi-IN')}</td>
                            <td>${call.call_duration_formatted || '0m 0s'}</td>
                            <td>
                                <span class="badge ${getStatusBadgeClass(call.call_status)}">
                                    ${call.call_status}
                                </span>
                            </td>
                            <td>${call.staff_name || '-'}</td>
                            <td>${call.disposition_details ? call.disposition_details.name : '-'}</td>
                            <td>${call.vehicle_model || '-'}</td>
                            <td>
                                ${call.is_lead ? `<span class="badge lead-${call.lead_quality}">${call.lead_quality || 'Lead'}</span>` : '-'}
                            </td>
                        </tr>
                    `).join('');

                    document.getElementById('callsTableBody').innerHTML = callsHtml;
                } else {
                    document.getElementById('callsTableBody').innerHTML =
                        '<tr><td colspan="9" style="text-align: center;">No calls found</td></tr>';
                }
            } catch (error) {
                document.getElementById('callsTableBody').innerHTML =
                    '<tr><td colspan="9" class="error">Error loading calls</td></tr>';
            }
        }

        function getStatusBadgeClass(status) {
            switch(status) {
                case 'completed':
                case 'answered':
                    return 'badge-success';
                case 'no-answer':
                case 'busy':
                    return 'badge-danger';
                case 'ringing':
                    return 'badge-warning';
                default:
                    return 'badge-info';
            }
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('leadFilter').value = '';
            document.getElementById('leadQualityFilter').value = '';
            loadCalls();
        }

        // Load data on page load
        loadStats();
        loadCalls();

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadStats();
            loadCalls();
        }, 30000);
    </script>
</body>
</html>
